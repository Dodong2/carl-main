import{D as V,T as Y,C as J,M as st,F as Ct,h as yt,w as ut,E as Ft,i as K,v as $,k as nt,l as it,R as Z,I as Tt,m as Q,o as G,p as vt}from"./index-BMRhF02N.js";import{C as rt}from"./CanvasPool-B-OT6a_m.js";class kt{constructor(t=0,e=0,s=!1){this.first=null,this.items=Object.create(null),this.last=null,this.max=t,this.resetTtl=s,this.size=0,this.ttl=e}clear(){return this.first=null,this.items=Object.create(null),this.last=null,this.size=0,this}delete(t){if(this.has(t)){const e=this.items[t];delete this.items[t],this.size--,e.prev!==null&&(e.prev.next=e.next),e.next!==null&&(e.next.prev=e.prev),this.first===e&&(this.first=e.next),this.last===e&&(this.last=e.prev)}return this}entries(t=this.keys()){const e=new Array(t.length);for(let s=0;s<t.length;s++){const n=t[s];e[s]=[n,this.get(n)]}return e}evict(t=!1){if(t||this.size>0){const e=this.first;delete this.items[e.key],--this.size===0?(this.first=null,this.last=null):(this.first=e.next,this.first.prev=null)}return this}expiresAt(t){let e;return this.has(t)&&(e=this.items[t].expiry),e}get(t){const e=this.items[t];if(e!==void 0){if(this.ttl>0&&e.expiry<=Date.now()){this.delete(t);return}return this.moveToEnd(e),e.value}}has(t){return t in this.items}moveToEnd(t){this.last!==t&&(t.prev!==null&&(t.prev.next=t.next),t.next!==null&&(t.next.prev=t.prev),this.first===t&&(this.first=t.next),t.prev=this.last,t.next=null,this.last!==null&&(this.last.next=t),this.last=t,this.first===null&&(this.first=t))}keys(){const t=new Array(this.size);let e=this.first,s=0;for(;e!==null;)t[s++]=e.key,e=e.next;return t}setWithEvicted(t,e,s=this.resetTtl){let n=null;if(this.has(t))this.set(t,e,!0,s);else{this.max>0&&this.size===this.max&&(n={...this.first},this.evict(!0));let i=this.items[t]={expiry:this.ttl>0?Date.now()+this.ttl:this.ttl,key:t,prev:this.last,next:null,value:e};++this.size===1?this.first=i:this.last.next=i,this.last=i}return n}set(t,e,s=!1,n=this.resetTtl){let i=this.items[t];return s||i!==void 0?(i.value=e,s===!1&&n&&(i.expiry=this.ttl>0?Date.now()+this.ttl:this.ttl),this.moveToEnd(i)):(this.max>0&&this.size===this.max&&this.evict(!0),i=this.items[t]={expiry:this.ttl>0?Date.now()+this.ttl:this.ttl,key:t,prev:this.last,next:null,value:e},++this.size===1?this.first=i:this.last.next=i,this.last=i),this}values(t=this.keys()){const e=new Array(t.length);for(let s=0;s<t.length;s++)e[s]=this.get(t[s]);return e}}function dt(o=1e3,t=0,e=!1){if(isNaN(o)||o<0)throw new TypeError("Invalid max value");if(isNaN(t)||t<0)throw new TypeError("Invalid ttl value");if(typeof e!="boolean")throw new TypeError("Invalid resetTtl value");return new kt(o,t,e)}function ft(o){return!!o.tagStyles&&Object.keys(o.tagStyles).length>0}function pt(o){return o.includes("<")}function Bt(o,t){return o.clone().assign(t)}function Lt(o,t){const e=[],s=t.tagStyles;if(!ft(t)||!pt(o))return e.push({text:o,style:t}),e;const n=[t],i=[];let r="",a=0;for(;a<o.length;){const h=o[a];if(h==="<"){const l=o.indexOf(">",a);if(l===-1){r+=h,a++;continue}const c=o.slice(a+1,l);if(c.startsWith("/")){const u=c.slice(1).trim();if(i.length>0&&i[i.length-1]===u){r.length>0&&(e.push({text:r,style:n[n.length-1]}),r=""),n.pop(),i.pop(),a=l+1;continue}else{r+=o.slice(a,l+1),a=l+1;continue}}else{const u=c.trim();if(s[u]){r.length>0&&(e.push({text:r,style:n[n.length-1]}),r="");const S=n[n.length-1],W=Bt(S,s[u]);n.push(W),i.push(u),a=l+1;continue}else{r+=o.slice(a,l+1),a=l+1;continue}}}else r+=h,a++}return r.length>0&&e.push({text:r,style:n[n.length-1]}),e}const zt=[10,13],Mt=new Set(zt),At=[9,32,8192,8193,8194,8195,8196,8197,8198,8200,8201,8202,8287,12288],Et=new Set(At),bt=/(\r\n|\r|\n)/,It=/(?:\r\n|\r|\n)/;function tt(o){return typeof o!="string"?!1:Mt.has(o.charCodeAt(0))}function P(o,t){return typeof o!="string"?!1:Et.has(o.charCodeAt(0))}function gt(o){return o==="normal"||o==="pre-line"}function xt(o){return o==="normal"}function H(o){if(typeof o!="string")return"";let t=o.length-1;for(;t>=0&&P(o[t]);)t--;return t<o.length-1?o.slice(0,t+1):o}function mt(o){const t=[],e=[];if(typeof o!="string")return t;for(let s=0;s<o.length;s++){const n=o[s],i=o[s+1];if(P(n)||tt(n)){e.length>0&&(t.push(e.join("")),e.length=0),n==="\r"&&i===`
`?(t.push(`\r
`),s++):t.push(n);continue}e.push(n)}return e.length>0&&t.push(e.join("")),t}function St(o,t,e,s){const n=e(o),i=[];for(let r=0;r<n.length;r++){let a=n[r],h=a,l=1;for(;n[r+l];){const c=n[r+l];if(!s(h,c,o,r,t))a+=c,h=c,l++;else break}r+=l-1,i.push(a)}return i}const Pt=/\r\n|\r|\n/g;function Rt(o,t,e,s,n,i,r,a){const h=Lt(o,t);if(xt(t.whiteSpace))for(let B=0;B<h.length;B++){const M=h[B];h[B]={text:M.text.replace(Pt," "),style:M.style}}const c=[];let u=[];for(const B of h){const M=B.text.split(bt);for(let b=0;b<M.length;b++){const A=M[b];A===`\r
`||A==="\r"||A===`
`?(c.push(u),u=[]):A.length>0&&u.push({text:A,style:B.style})}}(u.length>0||c.length===0)&&c.push(u);const S=e?Ht(c,t,s,n,r,a):c,W=[],T=[],F=[],w=[],d=[];let g=0;const C=t._fontString,m=i(C);m.fontSize===0&&(m.fontSize=t.fontSize,m.ascent=t.fontSize);let f="",_=!!t.dropShadow;for(const B of S){let M=0,b=m.ascent,A=m.descent,E="";for(const R of B){const j=R.style._fontString,X=i(j);j!==f&&(s.font=j,f=j);const D=n(R.text,R.style.letterSpacing,s);M+=D,b=Math.max(b,X.ascent),A=Math.max(A,X.descent),E+=R.text,!_&&R.style.dropShadow&&(_=!0)}B.length===0&&(b=m.ascent,A=m.descent),W.push(M),T.push(b),F.push(A),d.push(E);const I=t.lineHeight||b+A;w.push(I+t.leading),g=Math.max(g,M)}const v=t._stroke?.width||0,N=(e&&t.align!=="left"&&t.align!=="justify"?Math.max(g,t.wordWrapWidth):g)+v+(t.dropShadow?t.dropShadow.distance:0);let y=0;for(let B=0;B<w.length;B++)y+=w[B];y=Math.max(y,w[0]+v);const z=y+(t.dropShadow?t.dropShadow.distance:0),k=t.lineHeight||m.fontSize;return{width:N,height:z,lines:d,lineWidths:W,lineHeight:k+t.leading,maxLineWidth:g,fontProperties:m,runsByLine:S,lineAscents:T,lineDescents:F,lineHeights:w,hasDropShadow:_}}function Ht(o,t,e,s,n,i){const{letterSpacing:r,whiteSpace:a,wordWrapWidth:h,breakWords:l}=t,c=gt(a),u=h+r,S={};let W="";const T=(w,d)=>{const g=`${w}|${d.styleKey}`;let C=S[g];if(C===void 0){const m=d._fontString;m!==W&&(e.font=m,W=m),C=s(w,d.letterSpacing,e)+d.letterSpacing,S[g]=C}return C},F=[];for(const w of o){const d=Ot(w),g=F.length,C=y=>{let z=0,k=y;do{const{token:B,style:M}=d[k];z+=T(B,M),k++}while(k<d.length&&d[k].continuesFromPrevious);return z},m=y=>{const z=[];let k=y;do z.push({token:d[k].token,style:d[k].style}),k++;while(k<d.length&&d[k].continuesFromPrevious);return z};let f=[],_=0,v=!c,x=null;const L=()=>{x&&x.text.length>0&&f.push(x),x=null},N=()=>{if(L(),f.length>0){const y=f[f.length-1];y.text=H(y.text),y.text.length===0&&f.pop()}F.push(f),f=[],_=0,v=!1};for(let y=0;y<d.length;y++){const{token:z,style:k,continuesFromPrevious:B}=d[y],M=T(z,k);if(c){const E=P(z),I=x?.text[x.text.length-1]??f[f.length-1]?.text.slice(-1)??"",R=I?P(I):!1;if(E&&R)continue}const b=!B,A=b?C(y):M;if(A>u&&b)if(_>0&&N(),l){const E=m(y);for(let I=0;I<E.length;I++){const R=E[I].token,j=E[I].style,X=St(R,l,i,n);for(const D of X){const et=T(D,j);et+_>u&&N(),!x||x.style!==j?(L(),x={text:D,style:j}):x.text+=D,_+=et}}y+=E.length-1}else{const E=m(y);L(),F.push(E.map(I=>({text:I.token,style:I.style}))),v=!1,y+=E.length-1}else if(A+_>u&&b){if(P(z)){v=!1;continue}N(),x={text:z,style:k},_=M}else if(B&&!l)!x||x.style!==k?(L(),x={text:z,style:k}):x.text+=z,_+=M;else{const E=P(z);if(_===0&&E&&!v)continue;!x||x.style!==k?(L(),x={text:z,style:k}):x.text+=z,_+=M}}if(L(),f.length>0){const y=f[f.length-1];y.text=H(y.text),y.text.length===0&&f.pop()}(f.length>0||F.length===g)&&F.push(f)}return F}function Ot(o){const t=[];let e=!1;for(const s of o){const n=mt(s.text);let i=!0;for(const r of n){const a=P(r)||tt(r),h=i&&e&&!a;t.push({token:r,style:s.style,continuesFromPrevious:h}),e=!a,i=!1}}return t}const Nt={willReadFrequently:!0};function ot(o,t,e,s,n){let i=e[o];return typeof i!="number"&&(i=n(o,t,s)+t,e[o]=i),i}function jt(o,t,e,s,n,i,r){const a=e.getContext("2d",Nt);a.font=t._fontString;let h=0,l="";const c=[],u=Object.create(null),{letterSpacing:S,whiteSpace:W}=t,T=gt(W),F=xt(W);let w=!T;const d=t.wordWrapWidth+S,g=mt(o);for(let m=0;m<g.length;m++){let f=g[m];if(tt(f)){if(!F){c.push(H(l)),w=!T,l="",h=0;continue}f=" "}if(T){const v=P(f),x=P(l[l.length-1]);if(v&&x)continue}const _=ot(f,S,u,a,s);if(_>d)if(l!==""&&(c.push(H(l)),l="",h=0),n(f,t.breakWords)){const v=St(f,t.breakWords,r,i);for(const x of v){const L=ot(x,S,u,a,s);L+h>d&&(c.push(H(l)),w=!1,l="",h=0),l+=x,h+=L}}else l.length>0&&(c.push(H(l)),l="",h=0),c.push(H(f)),w=!1,l="",h=0;else _+h>d&&(w=!1,c.push(H(l)),l="",h=0),(l.length>0||!P(f)||w)&&(l+=f,h+=_)}const C=H(l);return C.length>0&&c.push(C),c.join(`
`)}const at={willReadFrequently:!0},O=class p{static get experimentalLetterSpacingSupported(){let t=p._experimentalLetterSpacingSupported;if(t===void 0){const e=V.get().getCanvasRenderingContext2D().prototype;t=p._experimentalLetterSpacingSupported="letterSpacing"in e||"textLetterSpacing"in e}return t}constructor(t,e,s,n,i,r,a,h,l,c){this.text=t,this.style=e,this.width=s,this.height=n,this.lines=i,this.lineWidths=r,this.lineHeight=a,this.maxLineWidth=h,this.fontProperties=l,c&&(this.runsByLine=c.runsByLine,this.lineAscents=c.lineAscents,this.lineDescents=c.lineDescents,this.lineHeights=c.lineHeights,this.hasDropShadow=c.hasDropShadow)}static measureText(t=" ",e,s=p._canvas,n=e.wordWrap){const i=`${t}-${e.styleKey}-wordWrap-${n}`;if(p._measurementCache.has(i))return p._measurementCache.get(i);if(ft(e)&&pt(t)){const f=Rt(t,e,n,p._context,p._measureText,p.measureFont,p.canBreakChars,p.wordWrapSplit),_=new p(t,e,f.width,f.height,f.lines,f.lineWidths,f.lineHeight,f.maxLineWidth,f.fontProperties,{runsByLine:f.runsByLine,lineAscents:f.lineAscents,lineDescents:f.lineDescents,lineHeights:f.lineHeights,hasDropShadow:f.hasDropShadow});return p._measurementCache.set(i,_),_}const a=e._fontString,h=p.measureFont(a);h.fontSize===0&&(h.fontSize=e.fontSize,h.ascent=e.fontSize,h.descent=0);const l=p._context;l.font=a;const u=(n?p._wordWrap(t,e,s):t).split(It),S=new Array(u.length);let W=0;for(let f=0;f<u.length;f++){const _=p._measureText(u[f],e.letterSpacing,l);S[f]=_,W=Math.max(W,_)}const T=e._stroke?.width??0,F=e.lineHeight||h.fontSize,w=p._getAlignWidth(W,e,n),d=p._adjustWidthForStyle(w,e),g=Math.max(F,h.fontSize+T)+(u.length-1)*(F+e.leading),C=p._adjustHeightForStyle(g,e),m=new p(t,e,d,C,u,S,F+e.leading,W,h);return p._measurementCache.set(i,m),m}static _adjustWidthForStyle(t,e){const s=e._stroke?.width||0;let n=t+s;return e.dropShadow&&(n+=e.dropShadow.distance),n}static _adjustHeightForStyle(t,e){let s=t;return e.dropShadow&&(s+=e.dropShadow.distance),s}static _getAlignWidth(t,e,s){return s&&e.align!=="left"&&e.align!=="justify"?Math.max(t,e.wordWrapWidth):t}static _measureText(t,e,s){let n=!1;p.experimentalLetterSpacingSupported&&(p.experimentalLetterSpacing?(s.letterSpacing=`${e}px`,s.textLetterSpacing=`${e}px`,n=!0):(s.letterSpacing="0px",s.textLetterSpacing="0px"));const i=s.measureText(t);let r=i.width;const a=-(i.actualBoundingBoxLeft??0);let l=(i.actualBoundingBoxRight??0)-a;if(r>0)if(n)r-=e,l-=e;else{const c=(p.graphemeSegmenter(t).length-1)*e;r+=c,l+=c}return Math.max(r,l)}static _wordWrap(t,e,s=p._canvas){return jt(t,e,s,p._measureText,p.canBreakWords,p.canBreakChars,p.wordWrapSplit)}static isBreakingSpace(t,e){return P(t)}static canBreakWords(t,e){return e}static canBreakChars(t,e,s,n,i){return!0}static wordWrapSplit(t){return p.graphemeSegmenter(t)}static measureFont(t){if(p._fonts[t])return p._fonts[t];const e=p._context;e.font=t;const s=e.measureText(p.METRICS_STRING+p.BASELINE_SYMBOL),n=s.actualBoundingBoxAscent??0,i=s.actualBoundingBoxDescent??0,r={ascent:n,descent:i,fontSize:n+i};return p._fonts[t]=r,r}static clearMetrics(t=""){t?delete p._fonts[t]:p._fonts={}}static get _canvas(){if(!p.__canvas){let t;try{const e=new OffscreenCanvas(0,0);if(e.getContext("2d",at)?.measureText)return p.__canvas=e,e;t=V.get().createCanvas()}catch{t=V.get().createCanvas()}t.width=t.height=10,p.__canvas=t}return p.__canvas}static get _context(){return p.__context||(p.__context=p._canvas.getContext("2d",at)),p.__context}};O.METRICS_STRING="|ÉqÅ";O.BASELINE_SYMBOL="M";O.BASELINE_MULTIPLIER=1.4;O.HEIGHT_MULTIPLIER=2;O.graphemeSegmenter=(()=>{if(typeof Intl?.Segmenter=="function"){const o=new Intl.Segmenter;return t=>{const e=o.segment(t),s=[];let n=0;for(const i of e)s[n++]=i.segment;return s}}return o=>[...o]})();O.experimentalLetterSpacing=!1;O._fonts={};O._measurementCache=dt(1e3);let q=O;function ht(o,t,e,s=0,n=0,i=0){if(o.texture===Y.WHITE&&!o.fill)return J.shared.setValue(o.color).setAlpha(o.alpha??1).toHexa();if(o.fill){if(o.fill instanceof Ct){const r=o.fill,a=t.createPattern(r.texture.source.resource,"repeat"),h=r.transform.copyTo(st.shared);return h.scale(r.texture.source.pixelWidth,r.texture.source.pixelHeight),a.setTransform(h),a}else if(o.fill instanceof yt){const r=o.fill,a=r.type==="linear";r.textureSpace;let h=1,l=1,c;if(a){const{start:u,end:S}=r;c=t.createLinearGradient(u.x*h+n,u.y*l+i,S.x*h+n,S.y*l+i),Math.abs(S.x-u.x)<Math.abs((S.y-u.y)*.1)}else{const{center:u,innerRadius:S,outerCenter:W,outerRadius:T}=r;c=t.createRadialGradient(u.x*h+n,u.y*l+i,S*h,W.x*h+n,W.y*l+i,T*h)}return r.colorStops.forEach(u=>{c.addColorStop(u.offset,J.shared.setValue(u.color).toHex())}),c}}else{const r=t.createPattern(o.texture.source.resource,"repeat"),a=o.matrix.copyTo(st.shared);return a.scale(o.texture.source.pixelWidth,o.texture.source.pixelHeight),r.setTransform(a),r}return ut("FillStyle not recognised",o),"red"}class wt extends Ft{constructor(){super(...arguments),this.chars=Object.create(null),this.lineHeight=0,this.fontFamily="",this.fontMetrics={fontSize:0,ascent:0,descent:0},this.baseLineOffset=0,this.distanceField={type:"none",range:0},this.pages=[],this.applyFillAsTint=!0,this.baseMeasurementFontSize=100,this.baseRenderedFontSize=100}get font(){return K($,"BitmapFont.font is deprecated, please use BitmapFont.fontFamily instead."),this.fontFamily}get pageTextures(){return K($,"BitmapFont.pageTextures is deprecated, please use BitmapFont.pages instead."),this.pages}get size(){return K($,"BitmapFont.size is deprecated, please use BitmapFont.fontMetrics.fontSize instead."),this.fontMetrics.fontSize}get distanceFieldRange(){return K($,"BitmapFont.distanceFieldRange is deprecated, please use BitmapFont.distanceField.range instead."),this.distanceField.range}get distanceFieldType(){return K($,"BitmapFont.distanceFieldType is deprecated, please use BitmapFont.distanceField.type instead."),this.distanceField.type}destroy(t=!1){this.emit("destroy",this),this.removeAllListeners();for(const e in this.chars)this.chars[e].texture?.destroy();this.chars=null,t&&(this.pages.forEach(e=>e.texture.destroy(!0)),this.pages=null)}}const _t=class Wt extends wt{constructor(t){super(),this.resolution=1,this.pages=[],this._padding=0,this._measureCache=Object.create(null),this._currentChars=[],this._currentX=0,this._currentY=0,this._currentMaxCharHeight=0,this._currentPageIndex=-1,this._skipKerning=!1;const e={...Wt.defaultOptions,...t};this._textureSize=e.textureSize,this._mipmap=e.mipmap;const s=e.style.clone();e.overrideFill&&(s._fill.color=16777215,s._fill.alpha=1,s._fill.texture=Y.WHITE,s._fill.fill=null),this.applyFillAsTint=e.overrideFill;const n=s.fontSize;s.fontSize=this.baseMeasurementFontSize;const i=nt(s);e.overrideSize?s._stroke&&(s._stroke.width*=this.baseRenderedFontSize/n):s.fontSize=this.baseRenderedFontSize=n,this._style=s,this._skipKerning=e.skipKerning??!1,this.resolution=e.resolution??1,this._padding=e.padding??4,e.textureStyle&&(this._textureStyle=e.textureStyle instanceof it?e.textureStyle:new it(e.textureStyle)),this.fontMetrics=q.measureFont(i),this.lineHeight=s.lineHeight||this.fontMetrics.fontSize||s.fontSize}ensureCharacters(t){const e=q.graphemeSegmenter(t).filter(w=>!this._currentChars.includes(w)).filter((w,d,g)=>g.indexOf(w)===d);if(!e.length)return;this._currentChars=[...this._currentChars,...e];let s;this._currentPageIndex===-1?s=this._nextPage():s=this.pages[this._currentPageIndex];let{canvas:n,context:i}=s.canvasAndContext,r=s.texture.source;const a=this._style;let h=this._currentX,l=this._currentY,c=this._currentMaxCharHeight;const u=this.baseRenderedFontSize/this.baseMeasurementFontSize,S=this._padding*u;let W=!1;const T=n.width/this.resolution,F=n.height/this.resolution;for(let w=0;w<e.length;w++){const d=e[w],g=q.measureText(d,a,n,!1);g.lineHeight=g.height;const C=g.width*u,m=Math.ceil((a.fontStyle==="italic"?2:1)*C),f=g.height*u,_=m+S*2,v=f+S*2;if(W=!1,d!==`
`&&d!=="\r"&&d!=="	"&&d!==" "&&(W=!0,c=Math.ceil(Math.max(v,c))),h+_>T&&(l+=c,c=v,h=0,l+c>F)){r.update();const L=this._nextPage();n=L.canvasAndContext.canvas,i=L.canvasAndContext.context,r=L.texture.source,h=0,l=0,c=0}const x=C/u-(a.dropShadow?.distance??0)-(a._stroke?.width??0);if(this.chars[d]={id:d.codePointAt(0),xOffset:-this._padding,yOffset:-this._padding,xAdvance:x,kerning:{}},W){this._drawGlyph(i,g,h+S,l+S,u,a);const L=r.width*u,N=r.height*u,y=new Z(h/L*r.width,l/N*r.height,_/L*r.width,v/N*r.height);this.chars[d].texture=new Y({source:r,frame:y}),h+=Math.ceil(_)}}r.update(),this._currentX=h,this._currentY=l,this._currentMaxCharHeight=c,this._skipKerning&&this._applyKerning(e,i)}get pageTextures(){return K($,"BitmapFont.pageTextures is deprecated, please use BitmapFont.pages instead."),this.pages}_applyKerning(t,e){const s=this._measureCache;for(let n=0;n<t.length;n++){const i=t[n];for(let r=0;r<this._currentChars.length;r++){const a=this._currentChars[r];let h=s[i];h||(h=s[i]=e.measureText(i).width);let l=s[a];l||(l=s[a]=e.measureText(a).width);let c=e.measureText(i+a).width,u=c-(h+l);u&&(this.chars[i].kerning[a]=u),c=e.measureText(i+a).width,u=c-(h+l),u&&(this.chars[a].kerning[i]=u)}}}_nextPage(){this._currentPageIndex++;const t=this.resolution,e=rt.getOptimalCanvasAndContext(this._textureSize,this._textureSize,t);this._setupContext(e.context,this._style,t);const s=t*(this.baseRenderedFontSize/this.baseMeasurementFontSize),n=new Y({source:new Tt({resource:e.canvas,resolution:s,alphaMode:"premultiply-alpha-on-upload",autoGenerateMipmaps:this._mipmap})});this._textureStyle&&(n.source.style=this._textureStyle);const i={canvasAndContext:e,texture:n};return this.pages[this._currentPageIndex]=i,i}_setupContext(t,e,s){e.fontSize=this.baseRenderedFontSize,t.scale(s,s),t.font=nt(e),e.fontSize=this.baseMeasurementFontSize,t.textBaseline=e.textBaseline;const n=e._stroke,i=n?.width??0;if(n&&(t.lineWidth=i,t.lineJoin=n.join,t.miterLimit=n.miterLimit,t.strokeStyle=ht(n,t)),e._fill&&(t.fillStyle=ht(e._fill,t)),e.dropShadow){const r=e.dropShadow,a=J.shared.setValue(r.color).toArray(),h=r.blur*s,l=r.distance*s;t.shadowColor=`rgba(${a[0]*255},${a[1]*255},${a[2]*255},${r.alpha})`,t.shadowBlur=h,t.shadowOffsetX=Math.cos(r.angle)*l,t.shadowOffsetY=Math.sin(r.angle)*l}else t.shadowColor="black",t.shadowBlur=0,t.shadowOffsetX=0,t.shadowOffsetY=0}_drawGlyph(t,e,s,n,i,r){const a=e.text,h=e.fontProperties,c=(r._stroke?.width??0)*i,u=s+c/2,S=n-c/2,W=h.descent*i,T=e.lineHeight*i;let F=!1;r.stroke&&c&&(F=!0,t.strokeText(a,u,S+T-W));const{shadowBlur:w,shadowOffsetX:d,shadowOffsetY:g}=t;r._fill&&(F&&(t.shadowBlur=0,t.shadowOffsetX=0,t.shadowOffsetY=0),t.fillText(a,u,S+T-W)),F&&(t.shadowBlur=w,t.shadowOffsetX=d,t.shadowOffsetY=g)}destroy(){super.destroy();for(let t=0;t<this.pages.length;t++){const{canvasAndContext:e,texture:s}=this.pages[t];rt.returnCanvasAndContext(e),s.destroy(!0)}this.pages=null}};_t.defaultOptions={textureSize:512,style:new Q,mipmap:!0};let lt=_t;function Gt(o,t,e,s){const n={width:0,height:0,offsetY:0,scale:t.fontSize/e.baseMeasurementFontSize,lines:[{width:0,charPositions:[],spaceWidth:0,spacesIndex:[],chars:[]}]};n.offsetY=e.baseLineOffset;let i=n.lines[0],r=null,a=!0;const h={width:0,start:0,index:0,positions:[],chars:[]},l=e.baseMeasurementFontSize/t.fontSize,c=t.letterSpacing*l,u=t.wordWrapWidth*l,S=t.lineHeight?t.lineHeight*l:e.lineHeight,W=t.wordWrap&&t.breakWords,T=d=>{const g=i.width;for(let C=0;C<h.index;C++){const m=d.positions[C];i.chars.push(d.chars[C]),i.charPositions.push(m+g)}i.width+=d.width,a=!1,h.width=0,h.index=0,h.chars.length=0},F=()=>{let d=i.chars.length-1;if(s){let g=i.chars[d];for(;g===" ";)i.width-=e.chars[g].xAdvance,g=i.chars[--d]}n.width=Math.max(n.width,i.width),i={width:0,charPositions:[],chars:[],spaceWidth:0,spacesIndex:[]},a=!0,n.lines.push(i),n.height+=S},w=d=>d-c>u;for(let d=0;d<o.length+1;d++){let g;const C=d===o.length;C||(g=o[d]);const m=e.chars[g]||e.chars[" "];if(/(?:\s)/.test(g)||g==="\r"||g===`
`||C){if(!a&&t.wordWrap&&w(i.width+h.width)?(F(),T(h),C||i.charPositions.push(0)):(h.start=i.width,T(h),C||i.charPositions.push(0)),g==="\r"||g===`
`)F();else if(!C){const x=m.xAdvance+(m.kerning[r]||0)+c;i.width+=x,i.spaceWidth=x,i.spacesIndex.push(i.charPositions.length),i.chars.push(g)}}else{const v=m.kerning[r]||0,x=m.xAdvance+v+c;W&&w(i.width+h.width+x)&&(T(h),F()),h.positions[h.index++]=h.width+v,h.chars.push(g),h.width+=x}r=g}return F(),t.align==="center"?Kt(n):t.align==="right"?$t(n):t.align==="justify"&&Dt(n),n}function Kt(o){for(let t=0;t<o.lines.length;t++){const e=o.lines[t],s=o.width/2-e.width/2;for(let n=0;n<e.charPositions.length;n++)e.charPositions[n]+=s}}function $t(o){for(let t=0;t<o.lines.length;t++){const e=o.lines[t],s=o.width-e.width;for(let n=0;n<e.charPositions.length;n++)e.charPositions[n]+=s}}function Dt(o){const t=o.width;for(let e=0;e<o.lines.length;e++){const s=o.lines[e];let n=0,i=s.spacesIndex[n++],r=0;const a=s.spacesIndex.length,l=(t-s.width)/a;for(let c=0;c<s.charPositions.length;c++)c===i&&(i=s.spacesIndex[n++],r+=l),s.charPositions[c]+=r}}function Yt(o){if(o==="")return[];typeof o=="string"&&(o=[o]);const t=[];for(let e=0,s=o.length;e<s;e++){const n=o[e];if(Array.isArray(n)){if(n.length!==2)throw new Error(`[BitmapFont]: Invalid character range length, expecting 2 got ${n.length}.`);if(n[0].length===0||n[1].length===0)throw new Error("[BitmapFont]: Invalid character delimiter.");const i=n[0].charCodeAt(0),r=n[1].charCodeAt(0);if(r<i)throw new Error("[BitmapFont]: Invalid character range.");for(let a=i,h=r;a<=h;a++)t.push(String.fromCharCode(a))}else t.push(...Array.from(n))}if(t.length===0)throw new Error("[BitmapFont]: Empty set when resolving characters.");return t}let U=0;class Xt{constructor(){this.ALPHA=[["a","z"],["A","Z"]," "],this.NUMERIC=[["0","9"]],this.ALPHANUMERIC=[["a","z"],["A","Z"],["0","9"]," "],this.ASCII=[[" ","~"]],this.defaultOptions={chars:this.ALPHANUMERIC,resolution:1,padding:4,skipKerning:!1,textureStyle:null},this.measureCache=dt(1e3)}getFont(t,e){let s=`${e.fontFamily}-bitmap`,n=!0;if(e._fill.fill&&!e._stroke?(s+=e._fill.fill.styleKey,n=!1):(e._stroke||e.dropShadow)&&(s=`${e.styleKey}-bitmap`,n=!1),!G.has(s)){const r=Object.create(e);r._lineHeight=0;const a=new lt({style:r,overrideFill:n,overrideSize:!0,...this.defaultOptions});U++,U>50&&ut("BitmapText",`You have dynamically created ${U} bitmap fonts, this can be inefficient. Try pre installing your font styles using \`BitmapFont.install({name:"style1", style})\``),a.once("destroy",()=>{U--,G.remove(s)}),G.set(s,a)}const i=G.get(s);return i.ensureCharacters?.(t),i}getLayout(t,e,s=!0){const n=this.getFont(t,e),i=`${t}-${e.styleKey}-${s}`;if(this.measureCache.has(i))return this.measureCache.get(i);const r=q.graphemeSegmenter(t),a=Gt(r,e,n,s);return this.measureCache.set(i,a),a}measureText(t,e,s=!0){return this.getLayout(t,e,s)}install(...t){let e=t[0];typeof e=="string"&&(e={name:e,style:t[1],chars:t[2]?.chars,resolution:t[2]?.resolution,padding:t[2]?.padding,skipKerning:t[2]?.skipKerning},K($,"BitmapFontManager.install(name, style, options) is deprecated, use BitmapFontManager.install({name, style, ...options})"));const s=e?.name;if(!s)throw new Error("[BitmapFontManager] Property `name` is required.");e={...this.defaultOptions,...e};const n=e.style,i=n instanceof Q?n:new Q(n),r=e.dynamicFill??this._canUseTintForStyle(i),a=new lt({style:i,overrideFill:r,skipKerning:e.skipKerning,padding:e.padding,resolution:e.resolution,overrideSize:!1,textureStyle:e.textureStyle}),h=Yt(e.chars);return a.ensureCharacters(h.join("")),G.set(`${s}-bitmap`,a),a.once("destroy",()=>G.remove(`${s}-bitmap`)),a}uninstall(t){const e=`${t}-bitmap`,s=G.get(e);s&&s.destroy()}_canUseTintForStyle(t){return!t._stroke&&(!t.dropShadow||t.dropShadow.color===0)&&!t._fill.fill&&t._fill.color===16777215}}const ct=new Xt;class Vt extends wt{constructor(t,e){super();const{textures:s,data:n}=t;Object.keys(n.pages).forEach(i=>{const r=n.pages[parseInt(i,10)],a=s[r.id];this.pages.push({texture:a})}),Object.keys(n.chars).forEach(i=>{const r=n.chars[i],{frame:a,source:h,rotate:l}=s[r.page],c=vt.transformRectCoords(r,a,l,new Z),u=new Y({frame:c,orig:new Z(0,0,r.width,r.height),source:h,rotate:l});this.chars[i]={id:i.codePointAt(0),xOffset:r.xOffset,yOffset:r.yOffset,xAdvance:r.xAdvance,kerning:r.kerning??{},texture:u}}),this.baseRenderedFontSize=n.fontSize,this.baseMeasurementFontSize=n.fontSize,this.fontMetrics={ascent:0,descent:0,fontSize:n.fontSize},this.baseLineOffset=n.baseLineOffset,this.lineHeight=n.lineHeight,this.fontFamily=n.fontFamily,this.distanceField=n.distanceField??{type:"none",range:0},this.url=e}destroy(){super.destroy();for(let t=0;t<this.pages.length;t++){const{texture:e}=this.pages[t];e.destroy(!0)}this.pages=null}static install(t){ct.install(t)}static uninstall(t){ct.uninstall(t)}}export{Vt as BitmapFont};
